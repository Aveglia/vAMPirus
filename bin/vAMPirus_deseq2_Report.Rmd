---
title: "vAMPirus Analyze Report `r commandArgs(trailingOnly=T)[1]`"
date: "Generated on: `r Sys.time()`"
output: html_document
params:
    interactive: TRUE
    projtag: !r commandArgs(trailingOnly=T)[1]
    deseq: |r commandArgs(trailingOnly=T)[2]
    compare: |r commandArgs(trailingOnly=T)[3]
---
<style>
.rectangle {
  height: 37px;
  width: 100%;
  background-color: #576675;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
      message = FALSE,
      warning = FALSE,
      out.width="100%")
```

```{r logo, echo=FALSE}
knitr::include_graphics("vamplogo.png")
```

```{r load_libraries, include=FALSE}
library(tidyverse)
library(plotly)
library(knitr)
library(rmarkdown)
library(ape)
```

```{r colors, include=FALSE}
mycol=c('#088da5','#73cdc8','#ff6f61','#7cb8df','#88b04b','#00a199','#6B5B95','#92A8D1','#b0e0e6','#ff7f50','#088d9b','#E15D44','#e19336')
```
<br>
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
NOTE: Most plots are interactive and you can use the legend to specify samples/treatment of interest. You can also download an .svg version of each figure within this report.
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

<div class="rectangle"><h2 style="color:white">&nbsp;&nbsp;DESeq2 Analyis</h2></div>

<br>
<br>
<br>
<br>
<br>
```{bash load_datasets_bash, include=FALSE}
if [ `ls *_ASV_Grouping.csv | wc -l` -ge 1 ];then
  cat *_ASV_Grouping.csv >asv_medfile.csv
  mv *_ASV_Groupingcounts.csv asv_groupcounts.csv
  cat asv_groupcounts.csv | awk -F "," '{print $1","$2}' >tree_group.csv
elif [ `ls *_AminoType_Grouping.csv | wc -l` -ge 1 ];then
  cat *_AminoType_Grouping.csv >amino_medfile.csv
  mv *_AminoType_Groupingcounts.csv amino_groupcounts.csv
  cat amino_groupcounts.csv | awk -F "," '{print $1","$2}' >tree_group.csv
fi
cat *_counts.csv >counts.csv
if [ `ls -1 *_phyloGroupingcounts.csv | wc -l` -ge 1 ];then
    mv *_phyloGroupingcounts.csv phylogroupcounts.csv
    ln -s ./phylogroupcounts.csv deseq_phylogroupcounts.csv
    cp *_phylogroup.csv ./phygroup.csv
fi
if [ params$deseq == "true" ]; then
    echo params$compare > compare.csv
fi

```

```{r deseq2_raw, echo=FALSE}
##dds object creation and analysis
if (params$deseq == "true") {
#read counts.csv
countData <- read.csv('counts.csv', header = TRUE, sep = ",")
#read compare value set by user
comp <- read.csv('compare.csv', header = FALSE, sep = ",")
#read metadata csv to get treatment info
metaData <- read.csv('params$metadata', header = TRUE, sep = ",")
#organize metadata CSV by treatment for deseq2 comparisons
if ( ncol(comp) == 2 ) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2))
} else if ( ncol(comp) == 3 ) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3))
} else if (ncol(comp) == 4) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3,comp$V4))
} else if (ncol(comp) == 5) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3,comp$V4,comp$V5))
} else if (ncol(comp) == 6) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3,comp$V4,comp$V5,comp$V6))
} else if (ncol(comp) == 7) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3,comp$V4,comp$V5,comp$V6,comp$V7))
} else if (ncol(comp) == 8) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3,comp$V4,comp$V5,comp$V6,comp$V7,comp$V8))
} else if (ncol(comp) == 9) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3,comp$V4,comp$V5,comp$V6,comp$V7,comp$V8,comp$V9))
} else if (ncol(comp) == 10) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3,comp$V4,comp$V5,comp$V6,comp$V7,comp$V8,comp$V9,comp$V10))
} else if (ncol(comp) == 11) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3,comp$V4,comp$V5,comp$V6,comp$V7,comp$V8,comp$V9,comp$V10,comp$V11))
} else if (ncol(comp) == 12) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3,comp$V4,comp$V5,comp$V6,comp$V7,comp$V8,comp$V9,comp$V10,comp$V11,comp$V12))
}
#Create deseq2 object
ddsraw <- DESeqDataSetFromMatrix(countData=countData, colData=metaData, design=~treatment, tidy = TRUE)
#fix sequences with zeros as counts
ddsraw <- estimateSizeFactors(ddsraw, type="poscounts")
#Run DEseq2
ddsraw <- DESeq(ddsraw)
#summarixe results and sort by pvalue
resraw <- results(ddsraw)
resOrdered <- resraw[order(resraw$pvalue),]
#generate deseq2 results.csv
write.csv(as.data.frame(resOrdered), file=""params$projtag"_deseq2_results.csv")

resnames[2, ] <- as.data.frame(resultsNames(ddsraw))



alpha = .05
res1 <- results(dds, name = "dex_infected_vs_healthy", cooksCutoff = FALSE)
res1 = res1[which(res1$padj < alpha),]
res1 = cbind(as(res1, "data.frame"),as(countData[rownames(res1), ], "matrix"))
res1$comparison <- "dex_infected_vs_healthy"
res2 <- results(dds, name = "dex_healthy_vs_apparhealthy", cooksCutoff = FALSE)
res2 = res2[which(res2$padj < alpha),]
res2 = cbind(as(res2, "data.frame"),as(countData[rownames(res2), ], "matrix"))
res2$comparison <- "dex_healthy_vs_apparhealthy"
#basic code to graph deseq outputs
islandside <- ggplot(res1, aes(x=rownames(res1), y=log2FoldChange, color=tres1$padj)) +
  facet_grid("comparison") + geom_point(size=6) +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5)) +
  theme(strip.text.x = element_text(size=10, face="bold"),
        strip.background = element_rect(fill="#FFFFFF"))
islandside

} else {
print("DEseq2 analysis not signaled to run. edit the config file or add --deseq to your launch command")
}
```
<br>
<br>
<br>
<br>
<br>

<div class="rectangle"><h2 style="color:white">&nbsp;&nbsp;DESeq2 Analyis -- MED </h2></div>

<br>
<br>

```{r deseq2_MED, echo=FALSE}
if (params$deseq == "true") {
countData <- read.csv('deseq_medtable.csv', header = TRUE, sep = ",")
metaData <- read.csv('params$metadata', header = TRUE, sep = ",")
comp <- read.csv('compare.csv', header = FALSE, sep = ",")

if ( ncol(comp) == 2 ) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2))
} else if ( ncol(comp) == 3 ) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3))
} else if (ncol(comp) == 4) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3,comp$V4))
} else if (ncol(comp) == 5) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3,comp$V4,comp$V5))
} else if (ncol(comp) == 6) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3,comp$V4,comp$V5,comp$V6))
} else if (ncol(comp) == 7) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3,comp$V4,comp$V5,comp$V6,comp$V7))
} else if (ncol(comp) == 8) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3,comp$V4,comp$V5,comp$V6,comp$V7,comp$V8))
} else if (ncol(comp) == 9) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3,comp$V4,comp$V5,comp$V6,comp$V7,comp$V8,comp$V9))
} else if (ncol(comp) == 10) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3,comp$V4,comp$V5,comp$V6,comp$V7,comp$V8,comp$V9,comp$V10))
} else if (ncol(comp) == 11) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3,comp$V4,comp$V5,comp$V6,comp$V7,comp$V8,comp$V9,comp$V10,comp$V11))
} else if (ncol(comp) == 12) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3,comp$V4,comp$V5,comp$V6,comp$V7,comp$V8,comp$V9,comp$V10,comp$V11,comp$V12))
}
ddsmed <- DESeqDataSetFromMatrix(countData=round(countData), colData=metaData, design=~treatment, tidy = TRUE)
ddsmed <- DESeq(dds)


} else {
print("DEseq2 analysis not signaled to run. edit the config file or add --deseq to your launch command")
}
```
<br>
<br>
<br>
<br>
<br>
<br>
<br>

<div class="rectangle"><h2 style="color:white">&nbsp;&nbsp;DESeq2 Analyis -- MED </h2></div>

<br>
<br>

```{r deseq2_MED, echo=FALSE}
if (params$deseq == "true") {
countData <- read.csv('deseq_phylogroupcounts.csv', header = TRUE, sep = ",")
metaData <- read.csv('params$metadata', header = TRUE, sep = ",")
comp <- read.csv('compare.csv', header = FASLE, sep = ",")
if ( ncol(comp) == 2 ) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2))
} else if ( ncol(comp) == 3 ) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3))
} else if (ncol(comp) == 4) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3,comp$V4))
} else if (ncol(comp) == 5) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3,comp$V4,comp$V5))
} else if (ncol(comp) == 6) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3,comp$V4,comp$V5,comp$V6))
} else if (ncol(comp) == 7) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3,comp$V4,comp$V5,comp$V6,comp$V7))
} else if (ncol(comp) == 8) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3,comp$V4,comp$V5,comp$V6,comp$V7,comp$V8))
} else if (ncol(comp) == 9) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3,comp$V4,comp$V5,comp$V6,comp$V7,comp$V8,comp$V9))
} else if (ncol(comp) == 10) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3,comp$V4,comp$V5,comp$V6,comp$V7,comp$V8,comp$V9,comp$V10))
} else if (ncol(comp) == 11) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3,comp$V4,comp$V5,comp$V6,comp$V7,comp$V8,comp$V9,comp$V10,comp$V11))
} else if (ncol(comp) == 12) {
  metaData$treatment <- factor(metaData$treatment, levels= c(comp$V1,comp$V2,comp$V3,comp$V4,comp$V5,comp$V6,comp$V7,comp$V8,comp$V9,comp$V10,comp$V11,comp$V12))
}
ddsphylo <- DESeqDataSetFromMatrix(countData=round(countData), colData=metaData, design=~treatment, tidy = TRUE)
ddsphylo <- DESeq(dds)
} else {
print("DEseq2 analysis not signaled to run. edit the config file or add --deseq to your launch command")
}
```
